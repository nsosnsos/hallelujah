{% if manage %}
    {% extends '_dropzone.html' %}
{% else %}
    {% extends '_base.html' %}
{% endif %}

{% block content %}
    <div class="row">
        {% if manage %}
            <div class="d-flex justify-content-center mt-5">
                <a class="btn btn-primary" href="{{ url_for('main.show_medias', current_path=current_path, _external=True) }}">
                    <i class="bi-link-45deg mx-1"></i>Show
                </a>
            </div>
            <div class="row mt-5">
                <form action="{{ url_for('main.upload', current_path=current_path, _external=True) }}" class="dropzone" id="upload-dropzone"></form>
            </div>
            <div class="row mt-5">
                <ol class="breadcrumb">
                    {% set path_list = current_path.split('/') %}
                    {% for dir_name in path_list %}
                        {% if loop.last %}
                            <li class="breadcrumb-item">{{ dir_name }}</li>
                        {% else %}
                            <li class="breadcrumb-item active">
                                {% if manage %}
                                    <a href="{{ url_for('main.manage_medias', current_path=os_path_join(*path_list[:loop.index]), _external=True) }}">{{ dir_name }}</a>
                                {% else %}
                                    <a href="{{ url_for('main.show_medias', current_path=os_path_join(*path_list[:loop.index]), _external=True) }}">{{ dir_name }}</a>
                                {% endif %}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ol>
            </div>
        {% else %}
            <div class="d-flex justify-content-center mt-5">
                <a class="btn btn-primary" href="{{ url_for('main.manage_medias', current_path=current_path, _external=True) }}">
                    <i class="bi-wrench-adjustable mx-1"></i>Manage
                </a>
            </div>
        {% endif %}
        <div class="row my-5">
            {% if manage %}
                <table class="table table-responsive table-sm table-hover">
                    <tbody>
                        {% for dir in dirs %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('main.manage_medias', current_path=os_path_join(current_path, dir), _external=True) }}">
                                        <i class="bi-folder mx-1"></i>{{ dir }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        {% for file in files %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('main.get_file', filename=file.uuidname, _external=True) }}">
                                        {{ file.filename }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Show medias in current directory...</p>
            {% endif %}
        </div>
    </div>
{% endblock content %}


{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
        window.addEventListener("load", data_container_adaption);
        window.addEventListener("resize", data_container_adaption);
        {% if manage %}
            Dropzone.options.uploadDropzone = {
                dictDefaultMessage: "Drop files here or click to upload",
                addRemoveLinks: true,
                uploadMultiple: true,
                parallelUploads: {{ config.DROPZONE_PARALLEL_UPLOADS }},
                maxFileSize: {{ config.DROPZONE_MAX_FILE_SIZE }},
                url: "{{ url_for('main.upload', current_path=current_path, _external=True) }}",
                init: function() {
                },
                success: function(file, response) {
                },
                successmultiple: function(files, response) {
                    for (let i in files) {
                        if (files[i].name in response) {
                            //files[i].name = response[files[i].name];
                            //files[i].serverName = response[files[i].name];
                            //files[i].previewElement.id = response[files[i].name];
                            files[i].previewElement.querySelector('[data-dz-name]').innerHTML = response[files[i].name];
                        }
                    }
                },
                removedfile: function(file, response) {
                    fetch("{{ url_for('main.delete_file', _external=True) }}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            filename: file.serverName,
                        }),
                    }).then(
                        response => response.json()
                    ).then(
                        json => {
                            file.previewElement.remove();
                        }
                    );
                },
            };
            var uploadDropzone = new Dropzone("#upload-dropzone");
        {% endif %}
    </script>
{% endblock scripts %}

