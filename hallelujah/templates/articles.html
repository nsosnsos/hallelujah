{% extends "_base.html" %}

{% block content %}
<div class="row mt-5">
    <div class="col-sm-9">
        <div id="data_div">
        </div>
        <div class="d-flex justify-content-center mb-5" id="sentinel">
            <div class="spinner-border" role="status"></div>
        </div>
    </div>
    <div class="col-sm-3">
        {% include 'sidebar.html' %}
    </div>
</div>
{% endblock content %}


{% block script %}
{{ super() }}
<script type="text/javascript">
    var data_div = document.querySelector("#data_div");
    var sentinel = document.querySelector("#sentinel");
    var limit = {{ config.ITEMS_PER_PAGE | tojson }};
    var load_url = {{ url_for('api.get_self_articles', _external=True) | tojson }};
    var offset = 0;

    var intersectionObserver = new IntersectionObserver(entries => {
        if (entries[0].intersectionRatio <= 0) {
            return;
        }
        load_data();
    });
    intersectionObserver.observe(sentinel);

    function load_data() {
        var fetch_url = `${load_url}?offset=${offset}`
        fetch(fetch_url).then(response => response.json()).then(data => {
            offset = offset + data.length;
            if (!data.length || data.length < limit) {
                sentinel.innerHTML = '<div class="text-muted">No more articles.</div>';
                intersectionObserver.unobserve(sentinel);
            }

            for (var index = 0; index < data.length; index++) {
                var page = `
                    <div class="card mb-5">
                        <div class="card-header">
                            <h5><a href="` + data[index].url + `">` + data[index].title +`</a></h5>
                        </div>
                        <div class="card-body">
                            ` + data[index].truncated_content + `
                        </div>
                        <div class="card-footer d-flex justify-content-between text-muted">
                            <div><a href="` + data[index].author_url + `">` + data[index].author + `</a></div>
                            <div>` + data[index].timestamp + `</div>
                        </div>
                    </div>`;
                $('#data_div').append(page);
            }
        });
    }
</script>
{% endblock script %}

